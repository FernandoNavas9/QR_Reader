<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Check-in</title>
    <!-- Tailwind CSS para el diseño -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Librería jsQR para decodificar QR -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        #video-container { 
            position: relative; 
            width: 100%; 
            max-width: 500px; 
            border-radius: 1rem; 
            overflow: hidden;
            border: 4px solid #374151; /* Borde más oscuro */
        }
        /* Línea de escaneo animada */
        #video-container::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: rgba(59, 130, 246, 0.8);
            box-shadow: 0 0 10px rgba(59, 130, 246, 1);
            animation: scan-line 2s infinite ease-in-out;
        }
        @keyframes scan-line {
            0% { transform: translateY(-120px); }
            50% { transform: translateY(120px); }
            100% { transform: translateY(-120px); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 text-center space-y-6">
        
        <header class="space-y-2">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-400">Sistema de Check-in de Evento</h1>
            <p class="text-gray-400">Apunta la cámara al código QR del invitado.</p>
        </header>

        <!-- Contenedor del video y canvas para procesar -->
        <div id="video-container" class="w-full mx-auto shadow-lg">
            <video id="video" playsinline class="w-full h-auto"></video>
            <canvas id="canvas" class="hidden"></canvas>
        </div>
        
        <!-- Área de estado del escaneo -->
        <div class="bg-gray-900/50 rounded-xl p-6">
            <p class="text-sm text-gray-500 mb-1">Estado del Registro:</p>
            <div id="scan-status" class="text-lg font-medium h-12 flex items-center justify-center rounded-lg transition-all duration-300">
                Iniciando cámara...
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');
        const statusDiv = document.getElementById('scan-status');
        let scanCooldown = false;

        // --- CONFIGURACIÓN IMPORTANTE ---
        // Pega aquí la URL de la aplicación web que obtuviste de Google Apps Script.
        const MI_API_URL = "https://script.google.com/macros/s/AKfycbwEjmLo_nuE5geH5Rln3BBSEtXA2RAm7s3vk58h3tVVOJ0WrfbF884axy9T6cmnt-qz/exec"; 
        // ---------------------------------

        // Función principal para iniciar la cámara
        function startCamera() {
            if (!MI_API_URL.includes("script.google.com")) {
                statusDiv.textContent = "Error: Configura la URL de la API.";
                statusDiv.className = "text-lg font-medium h-12 flex items-center justify-center rounded-lg bg-red-500/20 text-red-300";
                return;
            }

            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    statusDiv.textContent = "Esperando código QR...";
                    requestAnimationFrame(tick); // Inicia el ciclo de escaneo
                }).catch(err => {
                    console.error("Error al acceder a la cámara:", err);
                    statusDiv.textContent = "Error: Permiso de cámara denegado.";
                    statusDiv.className = "text-lg font-medium h-12 flex items-center justify-center rounded-lg bg-red-500/20 text-red-300";
                });
        }

        // Ciclo de escaneo que se ejecuta en cada frame
        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

                if (code && !scanCooldown) {
                    scanCooldown = true; // Activa el cooldown para evitar lecturas repetidas
                    handleQRCode(code.data);
                }
            }
            requestAnimationFrame(tick);
        }

        // Función para manejar el QR detectado y llamar a la API
        function handleQRCode(scannedID) {
            statusDiv.textContent = "Procesando ID...";
            statusDiv.className = "text-lg font-medium h-12 flex items-center justify-center rounded-lg bg-blue-500/20 text-blue-300";

            // Llama a tu API de Google Apps Script usando fetch
            fetch(`${MI_API_URL}?id=${scannedID}`)
                .then(response => response.json())
                .then(data => {
                    // Muestra el mensaje de la API
                    statusDiv.textContent = data.message;

                    // Cambia el color del estado según la respuesta
                    if (data.status === 'success') {
                        statusDiv.className = "text-lg font-medium h-12 flex items-center justify-center rounded-lg bg-green-500/20 text-green-300";
                    } else if (data.status === 'warning') {
                        statusDiv.className = "text-lg font-medium h-12 flex items-center justify-center rounded-lg bg-yellow-500/20 text-yellow-300";
                    } else {
                        statusDiv.className = "text-lg font-medium h-12 flex items-center justify-center rounded-lg bg-red-500/20 text-red-300";
                    }
                })
                .catch(error => {
                    console.error('Error en la llamada a la API:', error);
                    statusDiv.textContent = "Error de conexión con el servidor.";
                    statusDiv.className = "text-lg font-medium h-12 flex items-center justify-center rounded-lg bg-red-500/20 text-red-300";
                })
                .finally(() => {
                    // Desactiva el cooldown después de 3 segundos para permitir un nuevo escaneo
                    setTimeout(() => { 
                        scanCooldown = false;
                        statusDiv.textContent = "Esperando código QR...";
                        statusDiv.className = "text-lg font-medium h-12 flex items-center justify-center rounded-lg";
                    }, 3000);
                });
        }

        // Inicia todo el proceso
        startCamera();
    </script>
</body>
</html>



